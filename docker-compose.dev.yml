version: '3.8'

services:
  # The main Jellyfin server, which also acts as the rffmpeg orchestrator and NFS server
  jellyfin-server:
    image: ghcr.io/mels0n/jellyfin-rffmpeg-swarm-server:dev
    hostname: jellyfin-server-dev
    cap_add:
      - SYS_ADMIN
    environment:
      # Set your timezone, e.g., "America/Chicago"
      # - TZ=
      # Set NFS log level to DEBUG for verbose output. Default is INFO.
      - NFS_LOG_LEVEL=DEBUG
      - NFS_EXPORT_0=/transcodes *(rw,sync,no_subtree_check,no_root_squash,insecure)
      - NFS_EXPORT_1=/cache *(rw,sync,no_subtree_check,no_root_squash,insecure)
    ports:
      - "8097:8096" # Jellyfin Dev Web UI on a different port
    volumes:
      # Named volumes using an external NFS server for persistent data.
      # These are defined in the 'volumes:' section at the bottom of this file.
      - jellyfin_config_dev:/config
      - livetv_dev:/livetv
      - media:/media:ro
      # Host-path mounts for the directories this container will export via its own NFS server.
      # Ensure these directories exist on the node where this container runs.
      - /transcodes:/transcodes
      - /cache:/cache
      # Pass through GPU for hardware acceleration (optional)
      - /dev/dri:/dev/dri
    networks:
      - jellyfin-net
    secrets:
      - source: jellyfin_rffmpeg_id_rsa_dev
        target: rffmpeg_id_rsa
      - source: jellyfin_rffmpeg_id_rsa_pub_dev
        target: rffmpeg_id_rsa_pub
    deploy:
      mode: replicated
      replicas: 1

  # The rffmpeg transcode worker, scalable
  transcode-worker:
    image: ghcr.io/mels0n/jellyfin-rffmpeg-swarm-worker:dev
    hostname: "jellyfin-transcode-dev-{{.Task.Slot}}"
    # security_opt:
    #   - apparmor:unconfined
    cap_add:
      - SYS_ADMIN
    # Required so the worker container can run `mount -a` to mount the NFS exports
    # provided by the `jellyfin-server` container (exports: /transcodes and /cache).
    volumes:
      # Named volumes using an external NFS server, shared with the jellyfin-server.
      # The /transcodes and /cache directories are mounted internally by the container's
      # entrypoint script using the fstab defined in its Dockerfile.
      - jellyfin_config_dev:/config
      - media:/media:ro
      - livetv_dev:/livetv
      # Pass through GPU for hardware acceleration (optional)
      - /dev/dri:/dev/dri
    networks:
      - jellyfin-net
    secrets:
      - source: jellyfin_rffmpeg_id_rsa_pub_dev
        target: rffmpeg_id_rsa_pub
    deploy:
      mode: replicated
      replicas: 1 # Start with 1 worker for dev
      placement:
        max_replicas_per_node: 1

networks:
  jellyfin-net:
    driver: overlay

volumes:
  # IMPORTANT: These volumes point to separate dev paths on your NFS server.
  jellyfin_config_dev:
    driver_opts:
      type: "nfs"
      o: "addr=YOUR_NFS_SERVER_IP,nolock,soft,rw"
      device: ":/path/to/your/jellyfin/config_dev"
  livetv_dev:
    driver_opts:
      type: "nfs"
      o: "addr=YOUR_NFS_SERVER_IP,nolock,soft,rw"
      device: ":/path/to/your/livetv/recordings_dev"
  # The media volume can be shared with production
  media:
    driver_opts:
      type: "nfs"
      o: "addr=YOUR_NFS_SERVER_IP,nolock,soft,ro"
      device: ":/path/to/your/media"

secrets:
  jellyfin_rffmpeg_id_rsa_dev:
    external: true
  jellyfin_rffmpeg_id_rsa_pub_dev:
    external: true